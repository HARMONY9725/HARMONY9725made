<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>kanjiball</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; cursor: pointer; }
  </style>
</head>
<body>
<a href="https://harmony9725.github.io/HARMONY9725s_made/"><img id="sitelogo" src="images/sitelogo.png" alt="sitelogo"></a>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

function randomKanji() {
  const code = 0x4E00 + Math.floor(Math.random() * (0x9FFF - 0x4E00));
  return String.fromCharCode(code);
}

function randomVelocity(speed = 3) {
  const deg60 = Math.PI/3;
  let angle = (Math.random()<0.5) ? deg60 + Math.random()*(Math.PI-deg60*2) : Math.PI+deg60 + Math.random()*(Math.PI-deg60*2);
  return { vx: speed * Math.cos(angle), vy: speed * Math.sin(angle) };
}

const waves = [];
for(let i=0;i<30;i++){
  waves.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    radius: 100 + Math.random()*300,
    dx: (Math.random()-0.5)*0.3,
    dy: (Math.random()-0.5)*0.3,
    phase: Math.random()*Math.PI*2,
    speed: 0.02 + Math.random()*0.03
  });
}

class KanjiBall {
  constructor(x, y) {
    this.char = randomKanji();
    this.radius = 50; 
    this.x = x;
    this.y = y;
    const v = randomVelocity();
    this.vx = v.vx * 0.5;
    this.vy = v.vy * 0.5;
  }

  move() {
    this.x += this.vx;
    this.y += this.vy;
    if(this.x<this.radius){ this.x=this.radius; this.vx*=-1; }
    else if(this.x>canvas.width-this.radius){ this.x=canvas.width-this.radius; this.vx*=-1; }
    if(this.y<this.radius){ this.y=this.radius; this.vy*=-1; }
    else if(this.y>canvas.height-this.radius){ this.y=canvas.height-this.radius; this.vy*=-1; }
  }

  draw() {
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fillStyle="rgba(255,255,255,0.08)";
    ctx.fill();
    ctx.strokeStyle="white";
    ctx.lineWidth=2;
    ctx.stroke();
    ctx.font=`${this.radius*0.8}px 'Noto Sans JP', sans-serif`;
    ctx.fillStyle="white";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(this.char,this.x,this.y);
  }

  isClicked(mx, my) {
    const dx = mx - this.x;
    const dy = my - this.y;
    return Math.sqrt(dx*dx + dy*dy) <= this.radius;
  }
}

let balls=[];

function isOverlapping(x, y, radius) {
  for(let b of balls){
    const dx = x - b.x;
    const dy = y - b.y;
    if(Math.sqrt(dx*dx + dy*dy) < radius + b.radius) return true;
  }
  return false;
}

function safeSpawn() {
  let x, y;
  while(true){
    x = Math.random()*(canvas.width-100)+50;
    y = Math.random()*(canvas.height-100)+50;
    if(!isOverlapping(x, y, 50)) break;
  }
  balls.push(new KanjiBall(x, y));
}

function spawn() {
  if(balls.length < 30) safeSpawn();
}
setInterval(spawn, 1000);

function recycle() {
  if(balls.length >= 30){
    balls.shift();
    safeSpawn();
  }
}
setInterval(recycle, 5000);

function collide() {
  for(let i=0;i<balls.length;i++){
    for(let j=i+1;j<balls.length;j++){
      const a=balls[i], b=balls[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<a.radius+b.radius){
        [a.vx, b.vx] = [b.vx, a.vx];
        [a.vy, b.vy] = [b.vy, a.vy];
      }
    }
  }
}

function drawMarbleBackground() {
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let w of waves){
    w.phase += w.speed;
    const nx = w.x + Math.sin(w.phase)*80;
    const ny = w.y + Math.cos(w.phase)*80;
    const grad = ctx.createRadialGradient(nx,ny,0,nx,ny,w.radius);
    grad.addColorStop(0,"rgba(120,120,120,0.15)"); 
    grad.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.arc(nx,ny,w.radius,0,Math.PI*2);
    ctx.fill();
  }
}

canvas.addEventListener("click", (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  for(let b of balls){
    if(b.isClicked(mx, my)){
const code = b.char.codePointAt(0).toString(16); 
window.open(`https://kanji.me/kensaku/${code}.html`, "_blank");
      break;
    }
  }
});

function loop(){
  drawMarbleBackground();
  balls.forEach(b=>{ b.move(); b.draw(); });
  collide();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
