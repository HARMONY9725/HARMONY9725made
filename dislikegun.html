<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D Glock デモ</title>
  <style>
    html,body{height:100%;margin:0;background:#071425;color:#ddd;font-family:system-ui,Meiryo}
    #container{width:100%;height:100%;overflow:hidden;position:fixed;inset:0}
    .hud{position:fixed;left:12px;top:12px;z-index:55}
    .hint{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,0.45);padding:8px 12px;border-radius:8px;font-size:13px;z-index:55}
    #crosshair{position:fixed;left:50%;top:50%;width:32px;height:32px;margin:-16px 0 0 -16px;pointer-events:none;z-index:54;font-size:28px;text-align:center;line-height:28px;color:white;}
    button{background:#1b2430;border:1px solid #2f4458;color:#dfeeff;padding:8px 12px;border-radius:8px}
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="crosshair">+</div>
  <div class="hud">
    <div>弾: <span id="ammo">17</span>/<span id="reserve">102</span></div>
    <div>スコア: <span id="score">0</span></div>
    <div id="state">準備完了</div>
  </div>
  <div class="hint" id="startUI">
    <h3>3D Glock デモ</h3>
    <p>クリックでポインタロック、左クリックで射撃。Rでリロード、Fでフルスクリーン、Mでミュート。</p>
    <button id="startBtn">ゲーム開始</button>
    <p style="font-size:12px;margin-top:8px;">教育/エンタメ目的のシミュレーションです。実際の武器使用は禁止。</p>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.154.0/examples/jsm/controls/PointerLockControls.js';

    const container = document.getElementById('container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x071425);
    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0,1.6,0);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);

    window.addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // light
    const hemi = new THREE.HemisphereLight(0x88aaff, 0x20232a, 0.6); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,10,7); dir.castShadow=true; scene.add(dir);

    // floor
    const floorMat = new THREE.MeshStandardMaterial({color:0x0b1a23, roughness:0.9});
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(200,200), floorMat); floor.rotation.x = -Math.PI/2; floor.receiveShadow=true; scene.add(floor);

    // pointer lock
    const controls = new PointerLockControls(camera, renderer.domElement);
    document.getElementById('startBtn').addEventListener('click', ()=>{ controls.lock(); document.getElementById('startUI').style.display='none'; });
    controls.addEventListener('lock', ()=>{ document.getElementById('state').textContent='ポインタロック中'; });
    controls.addEventListener('unlock', ()=>{ document.getElementById('state').textContent='ポインタ解放'; document.getElementById('startUI').style.display='block'; });
    scene.add(controls.getObject());

    // simple gun
    const gun = new THREE.Group();
    const slide = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.08,0.12), new THREE.MeshStandardMaterial({color:0x333333, metalness:0.7, roughness:0.3}));
    slide.position.set(0.2,-0.1,-0.3); slide.castShadow=true; gun.add(slide);
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.12,0.2), new THREE.MeshStandardMaterial({color:0x1b1f23, metalness:0.2, roughness:0.5}));
    body.position.set(-0.05,-0.12,-0.35); body.castShadow=true; gun.add(body);
    gun.position.set(0.5,-0.25,-0.5); camera.add(gun);

    const muzzleLight = new THREE.PointLight(0xffcc88, 0, 5); camera.add(muzzleLight);

    // targets
    const targets = new THREE.Group(); scene.add(targets);
    function spawnTarget(){
      const x = (Math.random()-0.5)*20;
      const z = - (10 + Math.random()*30);
      const y = 0.6 + Math.random()*1.2;
      const geo = new THREE.CylinderGeometry(0.4,0.4,0.3,16);
      const mat = new THREE.MeshStandardMaterial({color:0xff5555});
      const t = new THREE.Mesh(geo, mat); t.position.set(x,y,z); t.castShadow=true; t.userData.hp = 1;
      targets.add(t);
    }
    for(let i=0;i<12;i++) spawnTarget();
    setInterval(()=>{ if(targets.children.length < 20) spawnTarget(); },1500);

    // ammo & score
    const MAG_CAP=17; let ammo=MAG_CAP, reserve=102, score=0;
    const ammoEl=document.getElementById('ammo'), reserveEl=document.getElementById('reserve'), scoreEl=document.getElementById('score'), stateEl=document.getElementById('state');
    ammoEl.textContent=ammo; reserveEl.textContent=reserve; scoreEl.textContent=score;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playShot(){ try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value=600; g.gain.value=0.03; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.05);
    const b=audioCtx.createBufferSource(); const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.02,audioCtx.sampleRate); const data=buf.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*Math.exp(-10*i/data.length); b.buffer=buf; b.connect(audioCtx.destination); b.start(); }catch(e){} }

    let firing=false; const raycaster=new THREE.Raycaster();
    function shoot(){
      if(ammo<=0){ stateEl.textContent='弾切れ — Rでリロード'; return; }
      ammo--; ammoEl.textContent=ammo; stateEl.textContent='発射！';
      playShot(); muzzleLight.intensity=3; setTimeout(()=>muzzleLight.intensity=0,60); gun.position.z=-0.55; setTimeout(()=>gun.position.z=-0.5,80);
      raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
      const hits=raycaster.intersectObjects(targets.children,false);
      if(hits.length>0){ const hit=hits[0].object; hit.userData.hp-=1; hit.scale.set(1.1,1.1,1.1); setTimeout(()=>hit.scale.set(1,1,1),120); if(hit.userData.hp<=0){ targets.remove(hit); score+=10; scoreEl.textContent=score; } }
    }

    document.addEventListener('mousedown',(e)=>{ if(e.button===0) { firing=true; shoot(); } });
    document.addEventListener('mouseup',(e)=>{ if(e.button===0) firing=false; });
    document.addEventListener('keydown',(e)=>{ if(e.key==='r'||e.key==='R'){ reload(); } if(e.key==='f'||e.key==='F'){ toggleFullscreen(); } if(e.key==='m'||e.key==='M'){ stateEl.textContent='ミュート'; } });
    function reload(){ if(ammo===MAG_CAP || reserve<=0){ stateEl.textContent='リロード不要'; return; } const need=MAG_CAP-ammo; const take=Math.min(need,reserve); reserve-=take; ammo+=take; ammoEl.textContent=ammo; reserveEl.textContent=reserve; stateEl.textContent='リロード完了'; }
    function toggleFullscreen(){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

    let lastShot=0; const fireRate=1000/6.5;
    const clock=new THREE.Clock();
    function animate(){ requestAnimationFrame(animate);
      if(firing && controls.isLocked){ const now=performance.now(); if(now-lastShot>fireRate){ shoot(); lastShot=now; } }
      const t=performance.now()/1000; gun.rotation.x=Math.sin(t*1.5)*0.02; gun.rotation.y=Math.sin(t*0.7)*0.01;
      for(const t of targets.children) t.rotation.y+=0.003;
      renderer.render(scene,camera);
    }
    animate();
  </script>
</body>
</html>
